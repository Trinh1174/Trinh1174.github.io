<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc ti·∫øng Vi·ªát</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="title-bar">
		<h1>H·ªçc ti·∫øng Vi·ªát</h1>
		<a href="index.html" class="button-link home-button">üè†</a>
	</div>

	<div class="vietnamese-keyboard-container"></div>
		<div class="input-container-clavier">
			<button id="maj-btn" class="vk-btn maj-btn" onclick="toggleMaj()">Maj</button>
			<input type="text" id="vietnamese-input" class="vietnamese-input" placeholder="Nh·∫≠p vƒÉn b·∫£n..." spellcheck="false">
			<button class="vk-btn copy-btn" onclick="copyText()">üìã Copier</button>
		</div>
		<div id="copy-toast" class="copy-toast">Copi√©</div>

		<div class="keyboard">

			<!-- Row 1: Vietnamese vowels and tones -->
			<div class="row">
				<button class="vk-btn vk-letter" onclick="insertChar('ƒÉ')">ƒÉ</button>
				<button class="vk-btn vk-letter" onclick="insertChar('√¢')">√¢</button>
				<button class="vk-btn vk-letter" onclick="insertChar('√™')">√™</button>
				<button class="vk-btn vk-letter" onclick="insertChar('√¥')">√¥</button>
				<button class="vk-btn vk-letter" onclick="insertChar('∆°')">∆°</button>
				<button class="vk-btn vk-letter" onclick="insertChar('∆∞')">∆∞</button>
				<button class="vk-btn vk-letter" onclick="addTone('s·∫Øc')">¬¥</button>
				<button class="vk-btn vk-letter" onclick="addTone('huy·ªÅn')">`</button>
				<button class="vk-btn vk-letter" onclick="addTone('h·ªèi')">?</button>
				<button class="vk-btn vk-letter" onclick="addTone('ng√£')">~</button>
				<button class="vk-btn vk-letter" onclick="addTone('n·∫∑ng')">.</button>
			</div>

			<!-- Row 2 -->
			<div class="row">
				<button class="vk-btn vk-letter" onclick="insertChar('q')">q</button>
				<button class="vk-btn vk-letter" onclick="insertChar('w')">w</button>
				<button class="vk-btn vk-letter" onclick="insertChar('e')">e</button>
				<button class="vk-btn vk-letter" onclick="insertChar('r')">r</button>
				<button class="vk-btn vk-letter" onclick="insertChar('t')">t</button>
				<button class="vk-btn vk-letter" onclick="insertChar('y')">y</button>
				<button class="vk-btn vk-letter" onclick="insertChar('u')">u</button>
				<button class="vk-btn vk-letter" onclick="insertChar('i')">i</button>
				<button class="vk-btn vk-letter" onclick="insertChar('o')">o</button>
				<button class="vk-btn vk-letter" onclick="insertChar('p')">p</button>
			</div>

			<!-- Row 3 -->
			<div class="row">
				<button class="vk-btn vk-letter" onclick="insertChar('a')">a</button>
				<button class="vk-btn vk-letter" onclick="insertChar('s')">s</button>
				<button class="vk-btn vk-letter" onclick="insertChar('d')">d</button>
				<button class="vk-btn vk-letter" onclick="insertChar('f')">f</button>
				<button class="vk-btn vk-letter" onclick="insertChar('g')">g</button>
				<button class="vk-btn vk-letter" onclick="insertChar('h')">h</button>
				<button class="vk-btn vk-letter" onclick="insertChar('j')">j</button>
				<button class="vk-btn vk-letter" onclick="insertChar('k')">k</button>
				<button class="vk-btn vk-letter" onclick="insertChar('l')">l</button>
				<button class="vk-btn vk-letter" onclick="insertChar('ƒë')">ƒë</button>
			</div>

			<!-- Row 4 -->
			<div class="row">
				<button class="vk-btn vk-letter" onclick="insertChar('z')">z</button>
				<button class="vk-btn vk-letter" onclick="insertChar('x')">x</button>
				<button class="vk-btn vk-letter" onclick="insertChar('c')">c</button>
				<button class="vk-btn vk-letter" onclick="insertChar('v')">v</button>
				<button class="vk-btn vk-letter" onclick="insertChar('b')">b</button>
				<button class="vk-btn vk-letter" onclick="insertChar('n')">n</button>
				<button class="vk-btn vk-letter" onclick="insertChar('m')">m</button>
			</div>

			<!-- Row 5: Vietnamese digraphs -->
			<div class="row">
				<button class="vk-btn vk-letter" onclick="insertChar('ch')">ch</button>
				<button class="vk-btn vk-letter" onclick="insertChar('gh')">gh</button>
				<button class="vk-btn vk-letter" onclick="insertChar('gi')">gi</button>
				<button class="vk-btn vk-letter" onclick="insertChar('kh')">kh</button>
				<button class="vk-btn vk-letter" onclick="insertChar('ng')">ng</button>
				<button class="vk-btn vk-letter" onclick="insertChar('ngh')">ngh</button>
				<button class="vk-btn vk-letter" onclick="insertChar('nh')">nh</button>
				<button class="vk-btn vk-letter" onclick="insertChar('ph')">ph</button>
				<button class="vk-btn vk-letter" onclick="insertChar('th')">th</button>
				<button class="vk-btn vk-letter" onclick="insertChar('tr')">tr</button>
			</div>

		</div>
	</div>

	<script>
		let lastChar = ''; // Le dernier caract√®re (ou digraphe) ins√©r√©
	
		const toneMap = {
			'a':  { 's·∫Øc': '√°', 'huy·ªÅn': '√†', 'h·ªèi': '·∫£', 'ng√£': '√£', 'n·∫∑ng': '·∫°' },
			'ƒÉ':  { 's·∫Øc': '·∫Ø', 'huy·ªÅn': '·∫±', 'h·ªèi': '·∫≥', 'ng√£': '·∫µ', 'n·∫∑ng': '·∫∑' },
			'√¢':  { 's·∫Øc': '·∫•', 'huy·ªÅn': '·∫ß', 'h·ªèi': '·∫©', 'ng√£': '·∫´', 'n·∫∑ng': '·∫≠' },
			'e':  { 's·∫Øc': '√©', 'huy·ªÅn': '√®', 'h·ªèi': '·∫ª', 'ng√£': '·∫Ω', 'n·∫∑ng': '·∫π' },
			'√™':  { 's·∫Øc': '·∫ø', 'huy·ªÅn': '·ªÅ', 'h·ªèi': '·ªÉ', 'ng√£': '·ªÖ', 'n·∫∑ng': '·ªá' },
			'i':  { 's·∫Øc': '√≠', 'huy·ªÅn': '√¨', 'h·ªèi': '·ªâ', 'ng√£': 'ƒ©', 'n·∫∑ng': '·ªã' },
			'o':  { 's·∫Øc': '√≥', 'huy·ªÅn': '√≤', 'h·ªèi': '·ªè', 'ng√£': '√µ', 'n·∫∑ng': '·ªç' },
			'√¥':  { 's·∫Øc': '·ªë', 'huy·ªÅn': '·ªì', 'h·ªèi': '·ªï', 'ng√£': '·ªó', 'n·∫∑ng': '·ªô' },
			'∆°':  { 's·∫Øc': '·ªõ', 'huy·ªÅn': '·ªù', 'h·ªèi': '·ªü', 'ng√£': '·ª°', 'n·∫∑ng': '·ª£' },
			'u':  { 's·∫Øc': '√∫', 'huy·ªÅn': '√π', 'h·ªèi': '·ªß', 'ng√£': '≈©', 'n·∫∑ng': '·ª•' },
			'∆∞':  { 's·∫Øc': '·ª©', 'huy·ªÅn': '·ª´', 'h·ªèi': '·ª≠', 'ng√£': '·ªØ', 'n·∫∑ng': '·ª±' },
			'y':  { 's·∫Øc': '√Ω', 'huy·ªÅn': '·ª≥', 'h·ªèi': '·ª∑', 'ng√£': '·ªπ', 'n·∫∑ng': '·ªµ' }
		};

		function updateKeyboardLetters() {
			const letterButtons = document.querySelectorAll('.vk-letter');
			letterButtons.forEach(btn => {
				// btn.textContent is always the lower case in your HTML, but the value to insert could be upper.
				// We use the button's onclick to get the char. But it's simpler to use the initial value.
				let baseChar = btn.getAttribute('data-base');
				if (!baseChar) {
					// Save the original char in a data attribute the first time.
					baseChar = btn.textContent;
					btn.setAttribute('data-base', baseChar);
				}
				btn.textContent = isMaj ? baseChar.toUpperCase() : baseChar.toLowerCase();
			});
		}
	
		function insertChar(char) {
			if (isMaj) {
				char = char.toUpperCase();
			}
			const input = document.getElementById('vietnamese-input');
			const start = input.selectionStart;
			const end   = input.selectionEnd;
			const text  = input.value;

			input.value = text.slice(0, start) + char + text.slice(end);
			input.focus();
			input.selectionStart = input.selectionEnd = start + char.length;
			lastChar = char;
		}
	
		function addTone(tone) {
			const input = document.getElementById('vietnamese-input');
			const text = input.value;
			if (!text || !lastChar) return;

			// Check if we need to preserve uppercase
			const isUpperCase = lastChar === lastChar.toUpperCase();
			// Use lowercase for lookups
			const lcLastChar = lastChar.toLowerCase();

			// 1) Check if lastChar is "gi" digraph (maybe already with tone)
			let isGi = false;
			let prefix = '';
			let vowelPart = '';

			if (lcLastChar.length >= 2 && lcLastChar[0] === 'g') {
				vowelPart = lcLastChar.slice(1); 
				const allItones = Object.values(toneMap['i']);
				if (vowelPart === 'i' || allItones.includes(vowelPart)) {
					isGi = true;
					prefix = isUpperCase ? 'G' : 'g';
				}
			}

			if (isGi) {
				const newVowel = toneMap['i'][tone];
				if (!newVowel) return;

				const idx = text.lastIndexOf(lastChar);
				if (idx !== -1) {
					const finalVowel = isUpperCase ? newVowel.toUpperCase() : newVowel;
					input.value =
						text.substring(0, idx) +
						prefix + finalVowel +
						text.substring(idx + lastChar.length);
					input.focus();
					input.selectionStart = input.selectionEnd = idx + prefix.length + 1;
					lastChar = prefix + finalVowel;
				}
				return;
			}

			// 2) Single letter case
			let baseLetter = null;
			for (const b in toneMap) {
				if (b === lcLastChar) {
					baseLetter = b;
					break;
				}
				for (const tName in toneMap[b]) {
					if (toneMap[b][tName] === lcLastChar) {
						baseLetter = b;
						break;
					}
				}
				if (baseLetter) break;
			}
			if (!baseLetter) return;

			let newChar = toneMap[baseLetter][tone];
			if (!newChar) return;

			// Apply uppercase if needed
			if (isUpperCase) {
				newChar = newChar.toUpperCase();
			}

			const idx2 = text.lastIndexOf(lastChar);
			if (idx2 !== -1) {
				input.value =
					text.substring(0, idx2) +
					newChar +
					text.substring(idx2 + lastChar.length);
				input.focus();
				input.selectionStart = input.selectionEnd = idx2 + 1;
				lastChar = newChar;
			}
		}
	
		let isMaj = false;

		function toggleMaj() {
		isMaj = !isMaj;
		document.getElementById('maj-btn')
				.classList.toggle('active', isMaj);
		updateKeyboardLetters();
		// keep focus on the input:
		document.getElementById('vietnamese-input').focus();
		}

		function copyText() {
			const input = document.getElementById('vietnamese-input');
			if (!input.value) return;
	
			input.select();
			input.setSelectionRange(0, 99999);
			navigator.clipboard.writeText(input.value).then(() => {
				const toast = document.getElementById('copy-toast');
				toast.classList.add('show');
				setTimeout(() => {
					toast.classList.remove('show');
				}, 1500);
			});
		}
	</script>	
</body>
</html>
